<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassDojo 學生排名顯示器</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 載入 Noto Sans TC & Fredoka 以獲得活潑的中英文字體 -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* 設定基本樣式 */
        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: #e0f2fe; /* 淺藍色背景 */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        /* 9:16 廣告機容器 - 確保在不同設備上都可見且比例正確 */
        .portrait-container {
            width: 100%;
            max-width: 550px; /* 限制最大寬度 */
            aspect-ratio: 9 / 16;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-radius: 2rem; /* 更圓潤的邊角 */
            border: 10px solid #f97316; /* 橙色邊框，像一個獎盃 */
            background-image: linear-gradient(135deg, #fefce8 0%, #fff7ed 100%); /* 柔和的漸變背景 */
        }
        
        /* 標題疊影效果 */
        .text-shadow-playful {
            /* 藍白疊影，更加突出 */
            text-shadow: 3px 3px 0 #fff, 5px 5px 0 #1e40af; 
        }

        /* 排名卡片動畫 */
        .rank-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: center;
        }
        .rank-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* 自定義滾動條樣式，讓列表更美觀 */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #fcd34d;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <!-- 9:16 廣告機屏幕容器 -->
    <div id="app" class="portrait-container flex flex-col p-6 sm:p-8">
        
        <!-- 標題區 -->
        <header class="text-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-black text-red-600 text-shadow-playful leading-tight">
                🌟 ClassDojo 排行榜
            </h1>
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2">
                <p id="class-title" class="text-xl sm:text-3xl font-extrabold p-2 bg-yellow-400 rounded-full inline-block shadow-lg border-4 border-red-500 text-blue-800 animate-pulse">
                    正在載入班級...
                </p>
                <!-- 頁碼指示器 -->
                <p id="page-indicator" class="text-sm sm:text-lg text-gray-700 font-semibold"></p>
            </div>
        </header>

        <!-- 排名列表區 (優化滾動) -->
        <div id="ranking-list" class="flex-grow overflow-y-auto space-y-4 p-2 custom-scroll">
            <!-- 排名卡片將由 JavaScript 填充 -->
            <div class="text-center text-gray-500 pt-10">請稍候，正在計算排名...</div>
        </div>

        <!-- 錯誤訊息或提示 -->
        <div id="error-message" class="hidden text-center text-red-600 font-bold p-4 bg-red-200 rounded-xl mt-4 border-4 border-red-500 animate-bounce">
            ❌ 找不到有效的班級數據。
        </div>
        
        <!-- 導航控制區 -->
        <div id="nav-controls" class="mt-6">
            <!-- 班級導航 -->
            <div id="class-nav-links" class="flex flex-wrap justify-center gap-3 mb-4 border-t-2 border-dashed border-gray-300 pt-3"></div>
            <!-- 分頁按鈕 -->
            <div id="pagination-controls" class="flex justify-between items-center px-2"></div>
        </div>

        <!-- 註腳 -->
        <footer class="text-center mt-4 text-gray-500 text-xs">
            <p id="footer-text">數據更新於：2025年10月25日</p>
        </footer>

    </div>

    <script>
        // ----------------------------------------------------
        // 1. 內嵌 CSV 數據 (請將您的報告內容貼在此處)
        // ----------------------------------------------------
        const csvData = `
        Name,Year,Classes,Positive,Needs Work,九月份班級經營得獎 - schoolwide (5),Answer questions (1),Appreciate you (1),Assembly (1),Attentive (1),Bible textbook (5),CHINESE HOMEWROK (1),Disobey (-5),Eng HW (1),English (Mr Ma) (1),English Dictation (1),English HW (1),FINISH LUNCH (1),Good student (5),Good students (5),Helping others (1),No textbook - (-1),On task (1),Participating (1),Persistence (1),Teamwork (1),Working hard (1),answer questions (1),bad behavior (-1),competition (5),disobey (-5),improvement (5),no textbook (mixed weight),not attentive (-1),sleeping (-1),一星期交齊功課 (5),上課表現良好 (1),不守規 (-1),不專心 (-1),不認真吃飯 (-1),不遵守紀律 (-1),中-上課有進步 (1),中-交齊功課 (1),中-專心上課 (1),中-積極嘗試 (1),交齊功課 (1),交齊數學功課 (1),全班交齊常識功課 (1),全班專心 (1),六望班級經營 (5),出位 (-1),功課GOOD (3),升旗隊 (1),午膳 (1),午膳表現良好 (1),協助老師 (1),周老師讚賞你 (1),回答問題 (1),圖書閱讀 (1),圖書館欠缺當值 (-2),圖書館沒有當值 (-2),圖書館當值 (1),大叫 (-1),安靜上禮堂 (3),完成每月篇篇流螢 (5),專心上課(數) (1),帶餐墊 (1),帶齊物品 (1),帶齊餐具 (1),常識功課 甲等表現 (1),常識表現好 (1),成績優異 (1),擅自出位 (-1),數學功課 (1),數學功課欠改正 (-1),早會表現良好 (1),早讀 (1),服務 (1),未完成全部功課 (-1),欠交功課 (-1),欠做功課 (-1),欠做改正 (-1),欠功課 (mixed weight),欠寫日期 (-1),欠帶課本 (-1),欠改正 (-1),欠數學功課 (-1),欠書 (-1),欠簽手冊 (-1),欠責任感 (-1),每日十題 (1),每月一聽 (5),沒有借/帶圖書 (-1),沒有舉手 (-1),甘老師欣賞你 (1),發電 (-1),積極答題 (1),自律守規 (1),蔡老師不欣賞你 (-1),蔡老師欣賞你 (1),蔡老師欣賞你☺️ (1),表現值得欣賞 (1),製造噪音 (-3),視藝課表現出色 (1),認真作答 (1),認真完成每日十題 (1),請專心 (-1)
        01_AFRIDI MUHAMMAD ZAMAN,1st Grade,2025-2026年度 1信,63,2,10,,,,,,,,,,,,1,,,1,,23,16,2,,2,,,,,,,,,,,-1,-1,,,,,,,,,,,,,,,,,,6,,,,,,,,,,,,,,,,,,,1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
        01_AYAAN SHER,2nd Grade,2025-2026年度 2信,141,3,,,,,,,,,,52,,3,,,,1,,19,12,5,7,6,,,,,,,,,,10,-1,,,,,,,,,,,,,,,,,,,,7,2,,,,,,,1,,,,,12,,,1,,1,,,,,,,,,,,,,,,,,-2,,,,,,,,,,,2,,,
        02_BOB_TESTER,1st Grade,2025-2026年度 1信,70,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        03_CHRIS_TESTER,2nd Grade,2025-2026年度 2信,120,0,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        04_DAVID_TESTER,1st Grade,2025-2026年度 1信,68,10,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        05_EVE_TESTER,2nd Grade,2025-2026年度 2信,141,1,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        06_FRANK_TESTER,1st Grade,2025-2026年度 1信,50,0,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        07_GRACE_TESTER,2nd Grade,2025-2026年度 2信,130,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        08_HANK_TESTER,1st Grade,2025-2026年度 1信,63,2,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        09_IVY_TESTER,2nd Grade,2025-2026年度 2信,141,3,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        10_JAKE_TESTER,1st Grade,2025-2026年度 1信,68,20,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        11_KATE_TESTER,2nd Grade,2025-2026年度 2信,125,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        12_LIAM_TESTER,1st Grade,2025-2026年度 1信,70,3,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        13_MIA_TESTER,2nd Grade,2025-2026年度 2信,141,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        14_NATHAN_TESTER,1st Grade,2025-2026年度 1信,55,1,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        15_OLIVIA_TESTER,2nd Grade,2025-2026年度 2信,130,2,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        `;
        
        // ----------------------------------------------------
        // 2. 變數聲明與數據處理
        // ----------------------------------------------------
        const PAGE_SIZE = 5; // 每頁顯示學生數
        let allClassRankings = {};
        
        // DOM 元素
        const rankingListEl = document.getElementById('ranking-list');
        const classTitleEl = document.getElementById('class-title');
        const pageIndicatorEl = document.getElementById('page-indicator');
        const errorMessageEl = document.getElementById('error-message');
        const classNavLinksEl = document.getElementById('class-nav-links');
        const paginationControlsEl = document.getElementById('pagination-controls');

        /**
         * 解析 CSV 數據，計算總分，並按班級分組。
         */
        function processData() {
            const lines = csvData.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return {};

            // 提取標頭
            const headers = lines[0].split(',');
            const dataLines = lines.slice(1);

            const NAME_INDEX = headers.indexOf('Name');
            const CLASS_INDEX = headers.indexOf('Classes');
            const POSITIVE_INDEX = headers.indexOf('Positive');
            const NEEDS_WORK_INDEX = headers.indexOf('Needs Work');

            if (NAME_INDEX === -1 || CLASS_INDEX === -1 || POSITIVE_INDEX === -1 || NEEDS_WORK_INDEX === -1) {
                console.error("CSV 標頭缺失: Name, Classes, Positive, 或 Needs Work.");
                return {};
            }

            const classData = {};

            dataLines.forEach(line => {
                // 使用簡易但能處理逗號的邏輯 (假設 Name/Classes/Positive/Needs Work 不含逗號)
                const values = line.split(',');

                const rawClass = values[CLASS_INDEX] ? values[CLASS_INDEX].trim().replace(/"/g, '') : '';
                const studentName = values[NAME_INDEX] ? values[NAME_INDEX].trim().replace(/"/g, '') : '';
                const positive = parseInt(values[POSITIVE_INDEX]) || 0;
                const needsWork = parseInt(values[NEEDS_WORK_INDEX]) || 0;

                // 簡化班級名稱: "2025-2026年度 3信" -> "3信"
                const classNameMatch = rawClass.match(/\s(\d\S+)$/);
                const className = classNameMatch ? classNameMatch[1] : rawClass;

                const totalScore = positive - needsWork;

                const student = {
                    name: studentName,
                    positive,
                    needsWork,
                    totalScore,
                    className
                };

                // 僅處理有有效班級名稱和學生名稱的數據
                if (className && studentName) {
                    if (!classData[className]) {
                        classData[className] = [];
                    }
                    classData[className].push(student);
                }
            });

            // 對每個班級進行排名 (總分降序)
            for (const className in classData) {
                classData[className].sort((a, b) => b.totalScore - a.totalScore);

                // 計算排名 (處理並列排名)
                classData[className].forEach((student, index, arr) => {
                    if (index > 0 && student.totalScore === arr[index - 1].totalScore) {
                        // 與前一個學生分數相同，排名相同
                        student.rank = arr[index - 1].rank;
                    } else {
                        // 新排名 (名次 = 索引 + 1)
                        student.rank = index + 1;
                    }
                });
            }

            return classData;
        }

        // ----------------------------------------------------
        // 3. 渲染 UI 核心
        // ----------------------------------------------------
        
        /**
         * 渲染分頁控制按鈕。
         * @param {string} className - 當前班級名稱。
         * @param {number} currentPage - 當前頁碼。
         * @param {number} totalPages - 總頁數。
         */
        function renderPaginationControls(className, currentPage, totalPages) {
            paginationControlsEl.innerHTML = '';
            
            const encodedClassName = encodeURIComponent(className);

            const prevDisabled = currentPage <= 1;
            const nextDisabled = currentPage >= totalPages;

            const prevHash = `#${encodedClassName}/${currentPage - 1}`;
            const nextHash = `#${encodedClassName}/${currentPage + 1}`;

            const baseClasses = "py-3 px-6 rounded-full font-extrabold text-lg shadow-xl transition duration-200 transform hover:scale-105";
            const enabledClasses = "bg-green-500 text-white hover:bg-green-600 ring-4 ring-green-300";
            const disabledClasses = "bg-gray-400 text-gray-700 opacity-70 cursor-not-allowed ring-2 ring-gray-300";

            // 上一頁按鈕
            const prevButton = `<a href="${prevDisabled ? '#' : prevHash}" class="${baseClasses} ${prevDisabled ? disabledClasses : enabledClasses}">
                <span class="text-xl mr-1">◀</span> 上一頁
            </a>`;

            // 下一頁按鈕
            const nextButton = `<a href="${nextDisabled ? '#' : nextHash}" class="${baseClasses} ${nextDisabled ? disabledClasses : enabledClasses}">
                下一頁 <span class="text-xl ml-1">▶</span>
            </a>`;

            paginationControlsEl.insertAdjacentHTML('beforeend', prevButton);
            paginationControlsEl.insertAdjacentHTML('beforeend', nextButton);
        }

        /**
         * 渲染班級導航連結。
         * @param {string} currentClassName - 當前班級名稱。
         */
        function renderClassNavLinks(currentClassName) {
            classNavLinksEl.innerHTML = '';
            const classNames = Object.keys(allClassRankings).sort(); // 按名稱排序，看起來更有序

            classNames.forEach(className => {
                const isCurrent = className === currentClassName;
                const encodedClassName = encodeURIComponent(className);
                const buttonClasses = isCurrent
                    ? 'bg-red-500 text-white shadow-lg ring-4 ring-yellow-400'
                    : 'bg-white text-gray-700 hover:bg-red-100 shadow-md ring-2 ring-gray-300';
                
                const link = `
                    <a href="#${encodedClassName}/1" class="py-2 px-4 text-md rounded-full font-bold transition duration-200 ${buttonClasses}">
                        ${className}
                    </a>
                `;
                classNavLinksEl.insertAdjacentHTML('beforeend', link);
            });
        }


        /**
         * 根據 URL Hash 渲染特定班級的排名。
         */
        function renderClassRanking() {
            const classKeys = Object.keys(allClassRankings);
            errorMessageEl.classList.add('hidden');

            if (classKeys.length === 0) {
                 // 找不到任何班級數據
                classTitleEl.textContent = '❌ 無效數據或無學生';
                pageIndicatorEl.textContent = '';
                rankingListEl.innerHTML = '<div class="text-center text-red-500 pt-10 font-bold">CSV 數據無效或缺少學生記錄。</div>';
                errorMessageEl.classList.remove('hidden');
                renderClassNavLinks(''); // 渲染空導航
                return;
            }

            // 1. 處理 Hash
            const hash = window.location.hash.substring(1); // e.g., "3信/2"
            const parts = hash.split('/');
            
            // 嘗試從 Hash 獲取班級名稱，否則使用第一個班級
            const defaultClassName = classKeys[0];
            const rawClassName = parts[0] || defaultClassName;
            let currentClassName = decodeURIComponent(rawClassName);

            // 如果從 hash 解碼出的班級不存在，則跳回第一個班級
            if (!allClassRankings[currentClassName]) {
                currentClassName = defaultClassName;
            }

            // 獲取頁碼，確保至少是 1
            const requestedPage = parseInt(parts[1] || '1', 10);
            
            const classStudents = allClassRankings[currentClassName];
            const totalStudents = classStudents.length;
            const totalPages = Math.ceil(totalStudents / PAGE_SIZE);

            // 確保頁碼有效
            const currentPage = Math.max(1, Math.min(requestedPage, totalPages));

            // 2. 數據分頁
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const studentsToDisplay = classStudents.slice(start, end);

            // 3. 更新標題和頁碼指示器
            classTitleEl.textContent = currentClassName + ' 🏆';
            pageIndicatorEl.textContent = `第 ${currentPage} 頁 / 共 ${totalPages} 頁`;

            // 4. 渲染學生排名
            rankingListEl.innerHTML = ''; // 清空列表
            studentsToDisplay.forEach(student => {
                const isFirst = student.rank === 1;
                const isSecond = student.rank === 2;
                const isThird = student.rank === 3;

                // 根據排名設定不同的顏色和風格
                let bgColor, borderColor, rankColor, rankText, icon;

                if (isFirst) {
                    bgColor = 'bg-yellow-400';
                    borderColor = 'border-6 border-red-600';
                    rankColor = 'text-red-700';
                    rankText = '🥇';
                    icon = '⭐';
                } else if (isSecond) {
                    bgColor = 'bg-gray-300';
                    borderColor = 'border-6 border-gray-600';
                    rankColor = 'text-gray-700';
                    rankText = '🥈';
                    icon = '✨';
                } else if (isThird) {
                    bgColor = 'bg-amber-300';
                    borderColor = 'border-6 border-orange-600';
                    rankColor = 'text-orange-700';
                    rankText = '🥉';
                    icon = '👍';
                } else {
                    bgColor = 'bg-white';
                    borderColor = 'border-4 border-blue-400';
                    rankColor = 'text-blue-600';
                    rankText = student.rank;
                    icon = '🟢';
                }

                const rankHtml = `
                    <div class="rank-card ${bgColor} ${borderColor} p-3 sm:p-5 rounded-3xl shadow-xl flex items-center">
                        <!-- 排名徽章/圖示 -->
                        <div class="w-12 h-12 sm:w-16 sm:h-16 flex-shrink-0 flex items-center justify-center font-extrabold text-2xl sm:text-3xl rounded-full bg-white ${rankColor} shadow-inner border-2 border-current transform rotate-[-5deg]">
                            ${rankText}
                        </div>
                        
                        <!-- 學生資訊 -->
                        <div class="flex-grow ml-4">
                            <p class="text-xl sm:text-2xl font-black text-blue-900 truncate">${icon} ${student.name}</p>
                            <p class="text-sm sm:text-base text-gray-600 font-semibold mt-1">
                                <span class="text-green-600">優點: ${student.positive}</span> / 
                                <span class="text-red-600">待改進: ${student.needsWork}</span>
                            </p>
                        </div>
                        
                        <!-- 總分 -->
                        <div class="flex-shrink-0 text-center ml-4">
                            <p class="text-xl sm:text-2xl font-black text-green-700 leading-tight">總分</p>
                            <p class="text-4xl sm:text-5xl font-black text-red-600">${student.totalScore}</p>
                        </div>
                    </div>
                `;
                rankingListEl.insertAdjacentHTML('beforeend', rankHtml);
            });
            
            // 5. 渲染控制項 (已啟用)
            renderPaginationControls(currentClassName, currentPage, totalPages);
            renderClassNavLinks(currentClassName);

            // 6. 如果當前頁碼不是 URL 中的頁碼，則更新 URL (用於修正無效頁碼)
            if (requestedPage !== currentPage || currentClassName !== decodeURIComponent(parts[0])) {
                window.history.replaceState(null, '', `#${encodeURIComponent(currentClassName)}/${currentPage}`);
            }
        }
        
        // ----------------------------------------------------
        // 4. 事件監聽器和初始化
        // ----------------------------------------------------

        // 監聽 URL Hash 變化，以模擬不同班級和頁面
        window.addEventListener('hashchange', renderClassRanking);

        // 頁面載入時初始化
        window.onload = function() {
            // 1. 處理數據
            allClassRankings = processData();
            
            const classKeys = Object.keys(allClassRankings);
            
            if (classKeys.length === 0) {
                 // 找不到任何班級數據，直接顯示錯誤
                 classTitleEl.textContent = '❌ 無效數據或無學生';
                 errorMessageEl.classList.remove('hidden');
                 rankingListEl.innerHTML = '';
                 renderClassNavLinks('');
                 return;
            }

            // 2. 設置初始 Hash 或執行渲染
            const hash = window.location.hash.substring(1);
            const initialClass = decodeURIComponent(hash.split('/')[0]);

            if (!hash || !allClassRankings[initialClass]) {
                // 如果沒有 Hash 或 Hash 無效，設定為第一個班級的第一頁
                window.location.hash = `#${encodeURIComponent(classKeys[0])}/1`;
            } else {
                // 否則，直接執行渲染
                renderClassRanking();
            }
        };

    </script>
</body>
</html>
