<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClassDojo å­¸ç”Ÿæ’åé¡¯ç¤ºå™¨</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¼‰å…¥ Noto Sans TC & Fredoka ä»¥ç²å¾—æ´»æ½‘çš„ä¸­è‹±æ–‡å­—é«” -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* è¨­å®šåŸºæœ¬æ¨£å¼ */
        body {
            font-family: 'Fredoka', 'Noto Sans TC', sans-serif;
            background-color: #e0f2fe; /* æ·ºè—è‰²èƒŒæ™¯ */
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }

        /* 9:16 å»£å‘Šæ©Ÿå®¹å™¨ - ç¢ºä¿åœ¨ä¸åŒè¨­å‚™ä¸Šéƒ½å¯è¦‹ä¸”æ¯”ä¾‹æ­£ç¢º */
        .portrait-container {
            width: 100%;
            max-width: 550px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            aspect-ratio: 9 / 16;
            margin: 0 auto;
            overflow: hidden;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-radius: 2rem; /* æ›´åœ“æ½¤çš„é‚Šè§’ */
            border: 10px solid #f97316; /* æ©™è‰²é‚Šæ¡†ï¼Œåƒä¸€å€‹çç›ƒ */
            background-image: linear-gradient(135deg, #fefce8 0%, #fff7ed 100%); /* æŸ”å’Œçš„æ¼¸è®ŠèƒŒæ™¯ */
        }
        
        /* æ¨™é¡Œç–Šå½±æ•ˆæœ */
        .text-shadow-playful {
            /* è—ç™½ç–Šå½±ï¼Œæ›´åŠ çªå‡º */
            text-shadow: 3px 3px 0 #fff, 5px 5px 0 #1e40af; 
        }

        /* æ’åå¡ç‰‡å‹•ç•« */
        .rank-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            transform-origin: center;
        }
        .rank-card:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“åˆ—è¡¨æ›´ç¾è§€ */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #fcd34d;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <!-- 9:16 å»£å‘Šæ©Ÿå±å¹•å®¹å™¨ -->
    <div id="app" class="portrait-container flex flex-col p-6 sm:p-8">
        
        <!-- æ¨™é¡Œå€ -->
        <header class="text-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-black text-red-600 text-shadow-playful leading-tight">
                ğŸŒŸ ClassDojo æ’è¡Œæ¦œ
            </h1>
            <div class="mt-4 flex flex-col sm:flex-row items-center justify-center gap-2">
                <p id="class-title" class="text-xl sm:text-3xl font-extrabold p-2 bg-yellow-400 rounded-full inline-block shadow-lg border-4 border-red-500 text-blue-800 animate-pulse">
                    æ­£åœ¨è¼‰å…¥ç­ç´š...
                </p>
                <!-- é ç¢¼æŒ‡ç¤ºå™¨ -->
                <p id="page-indicator" class="text-sm sm:text-lg text-gray-700 font-semibold"></p>
            </div>
        </header>

        <!-- æ’ååˆ—è¡¨å€ (å„ªåŒ–æ»¾å‹•) -->
        <div id="ranking-list" class="flex-grow overflow-y-auto space-y-4 p-2 custom-scroll">
            <!-- æ’åå¡ç‰‡å°‡ç”± JavaScript å¡«å…… -->
            <div class="text-center text-gray-500 pt-10">è«‹ç¨å€™ï¼Œæ­£åœ¨è¨ˆç®—æ’å...</div>
        </div>

        <!-- éŒ¯èª¤è¨Šæ¯æˆ–æç¤º -->
        <div id="error-message" class="hidden text-center text-red-600 font-bold p-4 bg-red-200 rounded-xl mt-4 border-4 border-red-500 animate-bounce">
            âŒ æ‰¾ä¸åˆ°æœ‰æ•ˆçš„ç­ç´šæ•¸æ“šã€‚
        </div>
        
        <!-- å°èˆªæ§åˆ¶å€ -->
        <div id="nav-controls" class="mt-6">
            <!-- ç­ç´šå°èˆª -->
            <div id="class-nav-links" class="flex flex-wrap justify-center gap-3 mb-4 border-t-2 border-dashed border-gray-300 pt-3"></div>
            <!-- åˆ†é æŒ‰éˆ• -->
            <div id="pagination-controls" class="flex justify-between items-center px-2"></div>
        </div>

        <!-- è¨»è…³ -->
        <footer class="text-center mt-4 text-gray-500 text-xs">
            <p id="footer-text">æ•¸æ“šæ›´æ–°æ–¼ï¼š2025å¹´10æœˆ25æ—¥</p>
        </footer>

    </div>

    <script>
        // ----------------------------------------------------
        // 1. å…§åµŒ CSV æ•¸æ“š (è«‹å°‡æ‚¨çš„å ±å‘Šå…§å®¹è²¼åœ¨æ­¤è™•)
        // ----------------------------------------------------
        const csvData = `
        Name,Year,Classes,Positive,Needs Work,ä¹æœˆä»½ç­ç´šç¶“ç‡Ÿå¾—ç - schoolwide (5),Answer questions (1),Appreciate you (1),Assembly (1),Attentive (1),Bible textbook (5),CHINESE HOMEWROK (1),Disobey (-5),Eng HW (1),English (Mr Ma) (1),English Dictation (1),English HW (1),FINISH LUNCH (1),Good student (5),Good students (5),Helping others (1),No textbook - (-1),On task (1),Participating (1),Persistence (1),Teamwork (1),Working hard (1),answer questions (1),bad behavior (-1),competition (5),disobey (-5),improvement (5),no textbook (mixed weight),not attentive (-1),sleeping (-1),ä¸€æ˜ŸæœŸäº¤é½ŠåŠŸèª² (5),ä¸Šèª²è¡¨ç¾è‰¯å¥½ (1),ä¸å®ˆè¦ (-1),ä¸å°ˆå¿ƒ (-1),ä¸èªçœŸåƒé£¯ (-1),ä¸éµå®ˆç´€å¾‹ (-1),ä¸­-ä¸Šèª²æœ‰é€²æ­¥ (1),ä¸­-äº¤é½ŠåŠŸèª² (1),ä¸­-å°ˆå¿ƒä¸Šèª² (1),ä¸­-ç©æ¥µå˜—è©¦ (1),äº¤é½ŠåŠŸèª² (1),äº¤é½Šæ•¸å­¸åŠŸèª² (1),å…¨ç­äº¤é½Šå¸¸è­˜åŠŸèª² (1),å…¨ç­å°ˆå¿ƒ (1),å…­æœ›ç­ç´šç¶“ç‡Ÿ (5),å‡ºä½ (-1),åŠŸèª²GOOD (3),å‡æ——éšŠ (1),åˆè†³ (1),åˆè†³è¡¨ç¾è‰¯å¥½ (1),å”åŠ©è€å¸« (1),å‘¨è€å¸«è®šè³ä½  (1),å›ç­”å•é¡Œ (1),åœ–æ›¸é–±è®€ (1),åœ–æ›¸é¤¨æ¬ ç¼ºç•¶å€¼ (-2),åœ–æ›¸é¤¨æ²’æœ‰ç•¶å€¼ (-2),åœ–æ›¸é¤¨ç•¶å€¼ (1),å¤§å« (-1),å®‰éœä¸Šç¦®å ‚ (3),å®Œæˆæ¯æœˆç¯‡ç¯‡æµè¢ (5),å°ˆå¿ƒä¸Šèª²(æ•¸) (1),å¸¶é¤å¢Š (1),å¸¶é½Šç‰©å“ (1),å¸¶é½Šé¤å…· (1),å¸¸è­˜åŠŸèª² ç”²ç­‰è¡¨ç¾ (1),å¸¸è­˜è¡¨ç¾å¥½ (1),æˆç¸¾å„ªç•° (1),æ“…è‡ªå‡ºä½ (-1),æ•¸å­¸åŠŸèª² (1),æ•¸å­¸åŠŸèª²æ¬ æ”¹æ­£ (-1),æ—©æœƒè¡¨ç¾è‰¯å¥½ (1),æ—©è®€ (1),æœå‹™ (1),æœªå®Œæˆå…¨éƒ¨åŠŸèª² (-1),æ¬ äº¤åŠŸèª² (-1),æ¬ åšåŠŸèª² (-1),æ¬ åšæ”¹æ­£ (-1),æ¬ åŠŸèª² (mixed weight),æ¬ å¯«æ—¥æœŸ (-1),æ¬ å¸¶èª²æœ¬ (-1),æ¬ æ”¹æ­£ (-1),æ¬ æ•¸å­¸åŠŸèª² (-1),æ¬ æ›¸ (-1),æ¬ ç°½æ‰‹å†Š (-1),æ¬ è²¬ä»»æ„Ÿ (-1),æ¯æ—¥åé¡Œ (1),æ¯æœˆä¸€è½ (5),æ²’æœ‰å€Ÿ/å¸¶åœ–æ›¸ (-1),æ²’æœ‰èˆ‰æ‰‹ (-1),ç”˜è€å¸«æ¬£è³ä½  (1),ç™¼é›» (-1),ç©æ¥µç­”é¡Œ (1),è‡ªå¾‹å®ˆè¦ (1),è”¡è€å¸«ä¸æ¬£è³ä½  (-1),è”¡è€å¸«æ¬£è³ä½  (1),è”¡è€å¸«æ¬£è³ä½ â˜ºï¸ (1),è¡¨ç¾å€¼å¾—æ¬£è³ (1),è£½é€ å™ªéŸ³ (-3),è¦–è—èª²è¡¨ç¾å‡ºè‰² (1),èªçœŸä½œç­” (1),èªçœŸå®Œæˆæ¯æ—¥åé¡Œ (1),è«‹å°ˆå¿ƒ (-1)
        01_AFRIDI MUHAMMAD ZAMAN,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,63,2,10,,,,,,,,,,,,1,,,1,,23,16,2,,2,,,,,,,,,,,-1,-1,,,,,,,,,,,,,,,,,,6,,,,,,,,,,,,,,,,,,,1,1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,
        01_AYAAN SHER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,141,3,,,,,,,,,,52,,3,,,,1,,19,12,5,7,6,,,,,,,,,,10,-1,,,,,,,,,,,,,,,,,,,,7,2,,,,,,,1,,,,,12,,,1,,1,,,,,,,,,,,,,,,,,-2,,,,,,,,,,,2,,,
        02_BOB_TESTER,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,70,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        03_CHRIS_TESTER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,120,0,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        04_DAVID_TESTER,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,68,10,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        05_EVE_TESTER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,141,1,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        06_FRANK_TESTER,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,50,0,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        07_GRACE_TESTER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,130,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        08_HANK_TESTER,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,63,2,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        09_IVY_TESTER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,141,3,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        10_JAKE_TESTER,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,68,20,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        11_KATE_TESTER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,125,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        12_LIAM_TESTER,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,70,3,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        13_MIA_TESTER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,141,5,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        14_NATHAN_TESTER,1st Grade,2025-2026å¹´åº¦ 1ä¿¡,55,1,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        15_OLIVIA_TESTER,2nd Grade,2025-2026å¹´åº¦ 2ä¿¡,130,2,10,1,1,1,1,1,1,-5,1,1,1,1,1,5,5,1,-1,1,1,1,1,1,1,-1,5,-5,5,1,-1,-1,5,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,5,-1,3,1,1,1,1,1,1,1,-2,-2,1,-1,3,5,1,1,1,1,1,1,1,-1,1,-1,1,1,1,-1,-1,-1,-1,1,-1,-1,-1,-1,-1,-1,-1,1,5,-1,-1,1,-1,1,1,-1,1,1,1,1,-3,1,1,1,-1
        `;
        
        // ----------------------------------------------------
        // 2. è®Šæ•¸è²æ˜èˆ‡æ•¸æ“šè™•ç†
        // ----------------------------------------------------
        const PAGE_SIZE = 5; // æ¯é é¡¯ç¤ºå­¸ç”Ÿæ•¸
        let allClassRankings = {};
        
        // DOM å…ƒç´ 
        const rankingListEl = document.getElementById('ranking-list');
        const classTitleEl = document.getElementById('class-title');
        const pageIndicatorEl = document.getElementById('page-indicator');
        const errorMessageEl = document.getElementById('error-message');
        const classNavLinksEl = document.getElementById('class-nav-links');
        const paginationControlsEl = document.getElementById('pagination-controls');

        /**
         * è§£æ CSV æ•¸æ“šï¼Œè¨ˆç®—ç¸½åˆ†ï¼Œä¸¦æŒ‰ç­ç´šåˆ†çµ„ã€‚
         */
        function processData() {
            const lines = csvData.trim().split('\n').filter(line => line.trim() !== '');
            if (lines.length < 2) return {};

            // æå–æ¨™é ­
            const headers = lines[0].split(',');
            const dataLines = lines.slice(1);

            const NAME_INDEX = headers.indexOf('Name');
            const CLASS_INDEX = headers.indexOf('Classes');
            const POSITIVE_INDEX = headers.indexOf('Positive');
            const NEEDS_WORK_INDEX = headers.indexOf('Needs Work');

            if (NAME_INDEX === -1 || CLASS_INDEX === -1 || POSITIVE_INDEX === -1 || NEEDS_WORK_INDEX === -1) {
                console.error("CSV æ¨™é ­ç¼ºå¤±: Name, Classes, Positive, æˆ– Needs Work.");
                return {};
            }

            const classData = {};

            dataLines.forEach(line => {
                // ä½¿ç”¨ç°¡æ˜“ä½†èƒ½è™•ç†é€—è™Ÿçš„é‚è¼¯ (å‡è¨­ Name/Classes/Positive/Needs Work ä¸å«é€—è™Ÿ)
                const values = line.split(',');

                const rawClass = values[CLASS_INDEX] ? values[CLASS_INDEX].trim().replace(/"/g, '') : '';
                const studentName = values[NAME_INDEX] ? values[NAME_INDEX].trim().replace(/"/g, '') : '';
                const positive = parseInt(values[POSITIVE_INDEX]) || 0;
                const needsWork = parseInt(values[NEEDS_WORK_INDEX]) || 0;

                // ç°¡åŒ–ç­ç´šåç¨±: "2025-2026å¹´åº¦ 3ä¿¡" -> "3ä¿¡"
                const classNameMatch = rawClass.match(/\s(\d\S+)$/);
                const className = classNameMatch ? classNameMatch[1] : rawClass;

                const totalScore = positive - needsWork;

                const student = {
                    name: studentName,
                    positive,
                    needsWork,
                    totalScore,
                    className
                };

                // åƒ…è™•ç†æœ‰æœ‰æ•ˆç­ç´šåç¨±å’Œå­¸ç”Ÿåç¨±çš„æ•¸æ“š
                if (className && studentName) {
                    if (!classData[className]) {
                        classData[className] = [];
                    }
                    classData[className].push(student);
                }
            });

            // å°æ¯å€‹ç­ç´šé€²è¡Œæ’å (ç¸½åˆ†é™åº)
            for (const className in classData) {
                classData[className].sort((a, b) => b.totalScore - a.totalScore);

                // è¨ˆç®—æ’å (è™•ç†ä¸¦åˆ—æ’å)
                classData[className].forEach((student, index, arr) => {
                    if (index > 0 && student.totalScore === arr[index - 1].totalScore) {
                        // èˆ‡å‰ä¸€å€‹å­¸ç”Ÿåˆ†æ•¸ç›¸åŒï¼Œæ’åç›¸åŒ
                        student.rank = arr[index - 1].rank;
                    } else {
                        // æ–°æ’å (åæ¬¡ = ç´¢å¼• + 1)
                        student.rank = index + 1;
                    }
                });
            }

            return classData;
        }

        // ----------------------------------------------------
        // 3. æ¸²æŸ“ UI æ ¸å¿ƒ
        // ----------------------------------------------------
        
        /**
         * æ¸²æŸ“åˆ†é æ§åˆ¶æŒ‰éˆ•ã€‚
         * @param {string} className - ç•¶å‰ç­ç´šåç¨±ã€‚
         * @param {number} currentPage - ç•¶å‰é ç¢¼ã€‚
         * @param {number} totalPages - ç¸½é æ•¸ã€‚
         */
        function renderPaginationControls(className, currentPage, totalPages) {
            paginationControlsEl.innerHTML = '';
            
            const encodedClassName = encodeURIComponent(className);

            const prevDisabled = currentPage <= 1;
            const nextDisabled = currentPage >= totalPages;

            const prevHash = `#${encodedClassName}/${currentPage - 1}`;
            const nextHash = `#${encodedClassName}/${currentPage + 1}`;

            const baseClasses = "py-3 px-6 rounded-full font-extrabold text-lg shadow-xl transition duration-200 transform hover:scale-105";
            const enabledClasses = "bg-green-500 text-white hover:bg-green-600 ring-4 ring-green-300";
            const disabledClasses = "bg-gray-400 text-gray-700 opacity-70 cursor-not-allowed ring-2 ring-gray-300";

            // ä¸Šä¸€é æŒ‰éˆ•
            const prevButton = `<a href="${prevDisabled ? '#' : prevHash}" class="${baseClasses} ${prevDisabled ? disabledClasses : enabledClasses}">
                <span class="text-xl mr-1">â—€</span> ä¸Šä¸€é 
            </a>`;

            // ä¸‹ä¸€é æŒ‰éˆ•
            const nextButton = `<a href="${nextDisabled ? '#' : nextHash}" class="${baseClasses} ${nextDisabled ? disabledClasses : enabledClasses}">
                ä¸‹ä¸€é  <span class="text-xl ml-1">â–¶</span>
            </a>`;

            paginationControlsEl.insertAdjacentHTML('beforeend', prevButton);
            paginationControlsEl.insertAdjacentHTML('beforeend', nextButton);
        }

        /**
         * æ¸²æŸ“ç­ç´šå°èˆªé€£çµã€‚
         * @param {string} currentClassName - ç•¶å‰ç­ç´šåç¨±ã€‚
         */
        function renderClassNavLinks(currentClassName) {
            classNavLinksEl.innerHTML = '';
            const classNames = Object.keys(allClassRankings).sort(); // æŒ‰åç¨±æ’åºï¼Œçœ‹èµ·ä¾†æ›´æœ‰åº

            classNames.forEach(className => {
                const isCurrent = className === currentClassName;
                const encodedClassName = encodeURIComponent(className);
                const buttonClasses = isCurrent
                    ? 'bg-red-500 text-white shadow-lg ring-4 ring-yellow-400'
                    : 'bg-white text-gray-700 hover:bg-red-100 shadow-md ring-2 ring-gray-300';
                
                const link = `
                    <a href="#${encodedClassName}/1" class="py-2 px-4 text-md rounded-full font-bold transition duration-200 ${buttonClasses}">
                        ${className}
                    </a>
                `;
                classNavLinksEl.insertAdjacentHTML('beforeend', link);
            });
        }


        /**
         * æ ¹æ“š URL Hash æ¸²æŸ“ç‰¹å®šç­ç´šçš„æ’åã€‚
         */
        function renderClassRanking() {
            const classKeys = Object.keys(allClassRankings);
            errorMessageEl.classList.add('hidden');

            if (classKeys.length === 0) {
                 // æ‰¾ä¸åˆ°ä»»ä½•ç­ç´šæ•¸æ“š
                classTitleEl.textContent = 'âŒ ç„¡æ•ˆæ•¸æ“šæˆ–ç„¡å­¸ç”Ÿ';
                pageIndicatorEl.textContent = '';
                rankingListEl.innerHTML = '<div class="text-center text-red-500 pt-10 font-bold">CSV æ•¸æ“šç„¡æ•ˆæˆ–ç¼ºå°‘å­¸ç”Ÿè¨˜éŒ„ã€‚</div>';
                errorMessageEl.classList.remove('hidden');
                renderClassNavLinks(''); // æ¸²æŸ“ç©ºå°èˆª
                return;
            }

            // 1. è™•ç† Hash
            const hash = window.location.hash.substring(1); // e.g., "3ä¿¡/2"
            const parts = hash.split('/');
            
            // å˜—è©¦å¾ Hash ç²å–ç­ç´šåç¨±ï¼Œå¦å‰‡ä½¿ç”¨ç¬¬ä¸€å€‹ç­ç´š
            const defaultClassName = classKeys[0];
            const rawClassName = parts[0] || defaultClassName;
            let currentClassName = decodeURIComponent(rawClassName);

            // å¦‚æœå¾ hash è§£ç¢¼å‡ºçš„ç­ç´šä¸å­˜åœ¨ï¼Œå‰‡è·³å›ç¬¬ä¸€å€‹ç­ç´š
            if (!allClassRankings[currentClassName]) {
                currentClassName = defaultClassName;
            }

            // ç²å–é ç¢¼ï¼Œç¢ºä¿è‡³å°‘æ˜¯ 1
            const requestedPage = parseInt(parts[1] || '1', 10);
            
            const classStudents = allClassRankings[currentClassName];
            const totalStudents = classStudents.length;
            const totalPages = Math.ceil(totalStudents / PAGE_SIZE);

            // ç¢ºä¿é ç¢¼æœ‰æ•ˆ
            const currentPage = Math.max(1, Math.min(requestedPage, totalPages));

            // 2. æ•¸æ“šåˆ†é 
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const studentsToDisplay = classStudents.slice(start, end);

            // 3. æ›´æ–°æ¨™é¡Œå’Œé ç¢¼æŒ‡ç¤ºå™¨
            classTitleEl.textContent = currentClassName + ' ğŸ†';
            pageIndicatorEl.textContent = `ç¬¬ ${currentPage} é  / å…± ${totalPages} é `;

            // 4. æ¸²æŸ“å­¸ç”Ÿæ’å
            rankingListEl.innerHTML = ''; // æ¸…ç©ºåˆ—è¡¨
            studentsToDisplay.forEach(student => {
                const isFirst = student.rank === 1;
                const isSecond = student.rank === 2;
                const isThird = student.rank === 3;

                // æ ¹æ“šæ’åè¨­å®šä¸åŒçš„é¡è‰²å’Œé¢¨æ ¼
                let bgColor, borderColor, rankColor, rankText, icon;

                if (isFirst) {
                    bgColor = 'bg-yellow-400';
                    borderColor = 'border-6 border-red-600';
                    rankColor = 'text-red-700';
                    rankText = 'ğŸ¥‡';
                    icon = 'â­';
                } else if (isSecond) {
                    bgColor = 'bg-gray-300';
                    borderColor = 'border-6 border-gray-600';
                    rankColor = 'text-gray-700';
                    rankText = 'ğŸ¥ˆ';
                    icon = 'âœ¨';
                } else if (isThird) {
                    bgColor = 'bg-amber-300';
                    borderColor = 'border-6 border-orange-600';
                    rankColor = 'text-orange-700';
                    rankText = 'ğŸ¥‰';
                    icon = 'ğŸ‘';
                } else {
                    bgColor = 'bg-white';
                    borderColor = 'border-4 border-blue-400';
                    rankColor = 'text-blue-600';
                    rankText = student.rank;
                    icon = 'ğŸŸ¢';
                }

                const rankHtml = `
                    <div class="rank-card ${bgColor} ${borderColor} p-3 sm:p-5 rounded-3xl shadow-xl flex items-center">
                        <!-- æ’åå¾½ç« /åœ–ç¤º -->
                        <div class="w-12 h-12 sm:w-16 sm:h-16 flex-shrink-0 flex items-center justify-center font-extrabold text-2xl sm:text-3xl rounded-full bg-white ${rankColor} shadow-inner border-2 border-current transform rotate-[-5deg]">
                            ${rankText}
                        </div>
                        
                        <!-- å­¸ç”Ÿè³‡è¨Š -->
                        <div class="flex-grow ml-4">
                            <p class="text-xl sm:text-2xl font-black text-blue-900 truncate">${icon} ${student.name}</p>
                            <p class="text-sm sm:text-base text-gray-600 font-semibold mt-1">
                                <span class="text-green-600">å„ªé»: ${student.positive}</span> / 
                                <span class="text-red-600">å¾…æ”¹é€²: ${student.needsWork}</span>
                            </p>
                        </div>
                        
                        <!-- ç¸½åˆ† -->
                        <div class="flex-shrink-0 text-center ml-4">
                            <p class="text-xl sm:text-2xl font-black text-green-700 leading-tight">ç¸½åˆ†</p>
                            <p class="text-4xl sm:text-5xl font-black text-red-600">${student.totalScore}</p>
                        </div>
                    </div>
                `;
                rankingListEl.insertAdjacentHTML('beforeend', rankHtml);
            });
            
            // 5. æ¸²æŸ“æ§åˆ¶é … (å·²å•Ÿç”¨)
            renderPaginationControls(currentClassName, currentPage, totalPages);
            renderClassNavLinks(currentClassName);

            // 6. å¦‚æœç•¶å‰é ç¢¼ä¸æ˜¯ URL ä¸­çš„é ç¢¼ï¼Œå‰‡æ›´æ–° URL (ç”¨æ–¼ä¿®æ­£ç„¡æ•ˆé ç¢¼)
            if (requestedPage !== currentPage || currentClassName !== decodeURIComponent(parts[0])) {
                window.history.replaceState(null, '', `#${encodeURIComponent(currentClassName)}/${currentPage}`);
            }
        }
        
        // ----------------------------------------------------
        // 4. äº‹ä»¶ç›£è½å™¨å’Œåˆå§‹åŒ–
        // ----------------------------------------------------

        // ç›£è½ URL Hash è®ŠåŒ–ï¼Œä»¥æ¨¡æ“¬ä¸åŒç­ç´šå’Œé é¢
        window.addEventListener('hashchange', renderClassRanking);

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        window.onload = function() {
            // 1. è™•ç†æ•¸æ“š
            allClassRankings = processData();
            
            const classKeys = Object.keys(allClassRankings);
            
            if (classKeys.length === 0) {
                 // æ‰¾ä¸åˆ°ä»»ä½•ç­ç´šæ•¸æ“šï¼Œç›´æ¥é¡¯ç¤ºéŒ¯èª¤
                 classTitleEl.textContent = 'âŒ ç„¡æ•ˆæ•¸æ“šæˆ–ç„¡å­¸ç”Ÿ';
                 errorMessageEl.classList.remove('hidden');
                 rankingListEl.innerHTML = '';
                 renderClassNavLinks('');
                 return;
            }

            // 2. è¨­ç½®åˆå§‹ Hash æˆ–åŸ·è¡Œæ¸²æŸ“
            const hash = window.location.hash.substring(1);
            const initialClass = decodeURIComponent(hash.split('/')[0]);

            if (!hash || !allClassRankings[initialClass]) {
                // å¦‚æœæ²’æœ‰ Hash æˆ– Hash ç„¡æ•ˆï¼Œè¨­å®šç‚ºç¬¬ä¸€å€‹ç­ç´šçš„ç¬¬ä¸€é 
                window.location.hash = `#${encodeURIComponent(classKeys[0])}/1`;
            } else {
                // å¦å‰‡ï¼Œç›´æ¥åŸ·è¡Œæ¸²æŸ“
                renderClassRanking();
            }
        };

    </script>
</body>
</html>
